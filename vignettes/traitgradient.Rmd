---
title: "Trait gradient analysis"
author: "Beni"
date: "7/6/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(RColorBrewer)
```

## Prepare data
```{r}
df <- read_csv("~/data/LeafNP_tiandi/Global_total_leaf_N_P_Di/leafnp_data_covariates_20210702.csv") %>% 
  dplyr::select(leafN, leafP, LeafNP, Family, Genus, Species, sitename) |> 
  
  # correct
  mutate(Family = ifelse(Species == "Acer saccharum", "Sapindaceae", Family))
```

Add site-mean to full data.
```{r}
df <- df %>% 
  group_by(sitename) %>% 
  summarise(leafN_sitemean = mean(leafN), leafP_sitemean = mean(leafP)) %>% 
  right_join(df, by = "sitename")
```

Add logarithms
```{r}
df <- df %>% 
  mutate(log_leafN = log10(leafN), 
         log_leafP = log10(leafP),
         log_leafN_sitemean = log10(leafN_sitemean),
         log_leafP_sitemean = log10(leafP_sitemean)
         )
```

Determine most common species (for plotting) with more than 50 observations
```{r}
# determine most common species
common_species <- df |> 
  group_by(Species) |> 
  summarise(n = n()) |> 
  filter(n >= 50) |> 
  pull(Species)
```

## Filter data

Use data only for species that appear in at least N sites.
```{r}
use_species <- df %>% 
  dplyr::select(sitename, Species) %>% 
  distinct() %>% 
  group_by(Species) %>% 
  summarise(n = n()) %>% 
  dplyr::filter(n >= 5) %>% 
  pull(Species)
```

Use data only for sites where at least M species are present.
```{r}
use_sites <- df %>% 
  dplyr::select(sitename, Species) %>% 
  distinct() %>% 
  group_by(sitename) %>% 
  summarise(n = n()) %>% 
  dplyr::filter(n >= 5) %>% 
  pull(sitename)
```

## TGA Plot

Plot.
```{r eval=FALSE}
df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  ggplot(aes(x = leafN_sitemean, y = leafN, color = Species)) +
  geom_point()
```

### Only lines

Plot just the lines
```{r}
df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  group_by(Species) %>% 
  ggplot(aes(x = leafN_sitemean, y = leafN, group = Species)) +
  geom_smooth(method = "lm", se = FALSE, size = 0.5, alpha = 0.2) +
  geom_abline(intercept=0, slope=1, linetype="dotted")
  # geom_point(alpha = 0.3)

df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  group_by(Species) %>% 
  ggplot(aes(x = leafP_sitemean, y = leafP, group = Species)) +
  geom_smooth(method = "lm", se = FALSE, size = 0.5, alpha = 0.2) +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  coord_equal() +
  theme_classic()
  # geom_point(alpha = 0.3)
```

### Analysis of slopes

Fit linear regressions by species.
```{r}
df_tga <- df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  group_by(Species) %>% 
  nest() %>% 
  mutate(linmod_n = purrr::map(data, ~lm(leafN ~ leafN_sitemean, data = .)),
         linmod_p = purrr::map(data, ~lm(leafP ~ leafP_sitemean, data = .))) %>% 
  mutate(slope_n = purrr::map_dbl(linmod_n, ~coef(.)[2]),
         slope_p = purrr::map_dbl(linmod_p, ~coef(.)[2])) %>% 
  left_join(df %>% 
              dplyr::select(Family, Genus, Species) %>% 
              distinct(), 
            by = "Species")

df_tga %>% 
  ggplot() +
  geom_histogram(aes(slope_n, ..density..), fill = "royalblue", binwidth = 0.1, alpha = 0.5) +
  geom_density(aes(slope_n, ..density..), color = "royalblue") +
  geom_histogram(aes(slope_p, ..density..), fill = "tomato", binwidth = 0.1, alpha = 0.5) +
  geom_density(aes(slope_p, ..density..), color = "tomato") +
  xlim(-2,3)

df_tga %>% 
  group_by(Family) %>% 
  summarise(slope_n = mean(slope_n)) %>% 
  mutate(Family = fct_reorder(Family, slope_n)) %>% 
  drop_na() %>% 
  ggplot(aes(Family, slope_n)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

## Logarithmic TGA Plot

Plot.
```{r eval=FALSE}
df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  ggplot(aes(x = log_leafN_sitemean, y = log_leafN, color = Species)) +
  geom_point()
```

### Only lines

Plot just the lines
```{r}
df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  group_by(Species) %>% 
  ggplot(aes(x = log_leafN_sitemean, y = log_leafN, group = Species)) +
  geom_smooth(method = "lm", se = FALSE, size = 0.1, alpha = 0.2, colour = "royalblue3") +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  theme_classic() +
  coord_equal() + 
  labs(x = expression(paste("log"[10], "(site mean leaf N)")), y = expression(paste("log"[10], "(species-level leaf N)")), title = "Leaf N")
  # geom_point(alpha = 0.3)
ggsave(paste0(here::here(), "/fig/tga_leafn_log.pdf"), width = 5, height = 4)

df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  group_by(Species) %>% 
  ggplot(aes(x = log_leafP_sitemean, y = log_leafP, group = Species)) +
  geom_smooth(method = "lm", se = FALSE, size = 0.1, alpha = 0.2, colour = "tomato3") +
  geom_abline(intercept=0, slope=1, linetype="dotted") +
  coord_equal() +
  theme_classic() + 
  labs(x = expression(paste("log"[10], "(site mean leaf P)")), y = expression(paste("log"[10], "(species-level leaf P)")), title = "Leaf P")
  # geom_point(alpha = 0.3)
ggsave(paste0(here::here(), "/fig/tga_leafp_log.pdf"), width = 5, height = 4)
```

### Analysis of slopes

Fit linear regressions by species.
```{r}
df_tga <- df %>% 
  dplyr::filter(Species %in% use_species & sitename %in% use_sites) %>% 
  group_by(Species) %>% 
  nest() %>% 
  mutate(linmod_n = purrr::map(data, ~lm(log_leafN ~ log_leafN_sitemean, data = .)),
         linmod_p = purrr::map(data, ~lm(log_leafP ~ log_leafP_sitemean, data = .))) %>% 
  mutate(slope_n = purrr::map_dbl(linmod_n, ~coef(.)[2]),
         slope_p = purrr::map_dbl(linmod_p, ~coef(.)[2])) %>% 
  left_join(df %>% 
              dplyr::select(Family, Genus, Species) %>% 
              distinct(), 
            by = "Species") |> 
  
  # remove outlier in slope P
  filter(slope_p > -5 & slope_p < 5)

cols <- c("slope_n" = "royalblue3", "slope_p" = "tomato3")

# distribution of slopes
df_tga %>% 
  ggplot() +
  geom_histogram(aes(slope_n, ..density..), fill = "royalblue3", binwidth = 0.1, alpha = 0.5) +
  geom_density(aes(slope_n, ..density.., color = "slope_n")) +
  geom_histogram(aes(slope_p, ..density..), fill = "tomato3", binwidth = 0.1, alpha = 0.5) +
  geom_density(aes(slope_p, ..density.., color = "slope_p")) +
  scale_color_manual(values = cols, labels = c("N", "P")) +
  xlim(-2,3) +
  theme_classic() +
  labs(x = "Slope", y = "Density") +
  geom_vline(xintercept = 1, linetype = "dotted")

ggsave(paste0(here::here(), "/fig/tga_slopes_density.pdf"), width = 7, height = 5)

# mean slopes by family: N
df_tga %>% 
  group_by(Family) %>% 
  summarise(slope_n = mean(slope_n)) %>% 
  mutate(Family = fct_reorder(Family, slope_n)) %>% 
  drop_na() %>% 
  ggplot(aes(Family, slope_n)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_classic() +
  labs(y = "Slope", title = "Leaf N") +
  geom_hline(yintercept = 1.0, linetype = "dotted") +
  geom_hline(yintercept = 0.0)

ggsave(paste0(here::here(), "/fig/tga_slopes_bars_leafn.pdf"), width = 7, height = 10)

# mean slopes by family: P
df_tga %>% 
  group_by(Family) %>% 
  summarise(slope_p = mean(slope_p)) %>% 
  mutate(Family = fct_reorder(Family, slope_p)) %>% 
  drop_na() %>% 
  ggplot(aes(Family, slope_p)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_classic() +
  labs(y = "Slope", title = "Leaf P") +
  geom_hline(yintercept = 1.0, linetype = "dotted") +
  geom_hline(yintercept = 0.0)

ggsave(paste0(here::here(), "/fig/tga_slopes_bars_leafp.pdf"), width = 7, height = 10)

# mean slopes of most common species: N
df_tga %>% 
  filter(Species %in% common_species) |> 
  group_by(Species) %>%
  summarise(slope_n = mean(slope_n)) %>%
  ungroup() |> 
  drop_na() %>% 
  left_join(df_tga |> 
              select(Species, Family, Genus) |> 
              distinct(),
            by = "Species") |> 
  mutate(Species = fct_reorder(Species, slope_n)) %>% 
  ggplot(aes(Species, slope_n, fill = Family)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_classic() +
  labs(y = "Slope", title = "Leaf N") +
  geom_hline(yintercept = 1.0, linetype = "dotted") +
  geom_hline(yintercept = 0.0)

ggsave(paste0(here::here(), "/fig/tga_slopes_bars_leafn_species.pdf"), width = 7, height = 7)

df_tga |> 
  filter(Species %in% common_species) |> 
  group_by(Species) |>
  summarise(slope_p = mean(slope_p)) |>
  ungroup() |> 
  drop_na() |> 
  left_join(df_tga |> 
              select(Species, Family, Genus) |> 
              distinct(),
            by = "Species") |> 
  mutate(Species = fct_reorder(Species, slope_p)) |> 
  ggplot(aes(Species, slope_p, fill = Family)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_classic() +
  labs(y = "Slope", title = "Leaf P") +
  geom_hline(yintercept = 1.0, linetype = "dotted") +
  geom_hline(yintercept = 0.0)

ggsave(paste0(here::here(), "/fig/tga_slopes_bars_leafp_species.pdf"), width = 7, height = 7)

# correlation of slopes
out <- df_tga |> 
  # remove outliers
  filter(slope_n > -5, slope_n < 5, slope_p > -5, slope_p < 5) |> 
  rbeni::analyse_modobs2("slope_p", "slope_n", rsquared = FALSE)

out$gg
```